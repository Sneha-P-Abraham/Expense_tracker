<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budgets - Budget App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/scrollreveal"></script>
    <style>
        /* style.css - Embedded within HTML */
        html, body {
            height: 100vh;
        }

        body {
            font-family: sans-serif;
            margin: 0;
            background-color: #1e1e1e;
            color: #f0e6d4;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .app-container {
            width: 375px;
            background-color: #2c2c2c;
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            position: relative;
        }

        header {
            padding: 20px;
            text-align: left;
            display: flex;
            align-items: center;
        }

        header h1 {
            margin-bottom: 0;
            font-size: 1.8em;
            font-weight: normal;
            flex-grow: 1;
        }

        header i {
            font-size: 1.8em;
            margin-right: 15px;
            color: #f0e6d4;
        }

        .budget-page-content {
            padding: 20px;
            margin: 0 20px 20px 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .add-budget-section {
            display: none;
            background-color: #3a3a3a;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
             /* Ensure form is scrollable if content is too long */
            overflow-y: auto;
            max-height: calc(100vh - 140px); /* Adjust max height to fit within viewport */
        }

        .budget-type-options {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .budget-option {
            background-color: #444;
            border-radius: 10px;
            padding: 10px 15px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .budget-option.active {
            background-color: #555;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            text-align: left;
            margin-bottom: 5px;
            color: #d0d0d0;
        }

        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: none;
            background-color: #444;
            color: #f0e6d4;
            font-family: sans-serif;
            font-size: 1em;
        }

        /* Updated Period Input Group Styles */
        .period-info {
            text-align: left;
            margin-bottom: 20px;
            color: #d0d0d0;
            font-size: 0.9em;
        }

        .period-input-group {
            display: flex;
            flex-direction: row; /* Arrange items in a row */
            align-items: center; /* Vertically align items */
            gap: 10px; /* Space between items */
            margin-bottom: 15px; /* Increased bottom margin for better spacing */
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
        }

        .period-input-group label {
            margin-bottom: 0; /* Remove bottom margin from labels in this group */
            text-align: left; /* Keep label text alignment */
            color: #d0d0d0;
            white-space: nowrap; /* Prevent labels from wrapping */
        }

        .period-input-group input[type="number"],
        .period-input-group select,
        .period-input-group input[type="date"] {
            flex-grow: 1; /* Allow inputs to take up available space */
            min-width: 80px; /* Minimum width for input fields */
            padding: 10px;
            border-radius: 10px;
            border: none;
            background-color: #444;
            color: #f0e6d4;
            font-family: sans-serif;
            font-size: 1em;
        }

        .period-input-group select {
            width: auto; /* Adjust width of select to content */
            flex-grow: 0; /* Prevent select from expanding too much */
        }

        .period-input-group input[type="date"] {
            width: auto; /* Adjust width of date input to content */
            flex-grow: 0; /* Prevent date input from expanding too much */
        }


        .period-details {
            text-align: left;
            margin-bottom: 20px;
            color: #d0d0d0;
            font-size: 0.9em;
        }


        /* Budget Progress and Suggestion in List */
        .budget-list-progress-info {
            display: flex;
            flex-direction: column; /* Stack progress bar and suggestion */
            gap: 5px; /* Space between progress bar and suggestion */
        }

        .budget-progress {
            background-color: #444;
            border-radius: 10px;
            height: 8px; /* Reduced height */
            position: relative;
            margin-bottom: 0; /* Remove margin */
            overflow: hidden; /* Clip content to border-radius */
        }

        .budget-progress-bar {
            background-color: #b8860b;
            height: 100%;
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease-out; /* Smooth width transition */
        }


        .budget-percentage {
            position: absolute;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            font-size: 0.6em; /* Smaller percentage text */
            color: #d0d0d0;
            opacity: 1; /* Make percentage visible by default */
            transition: opacity 0.3s ease-out; /* Fade in animation */
        }


        .budget-suggestion {
            font-size: 0.8em; /* Smaller suggestion text */
            color: #d0d0d0;
            text-align: left; /* Align suggestion text to the left */
        }

        .delete-button {
            background: none;
            border: none;
            color: #e24040; /* Red color for delete icon */
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 5px;
        }


        /* Bottom Navigation */
        .bottom-nav {
            background-color: #2c2c2c;
            display: flex;
            justify-content: space-around;
            padding: 15px 20px;
            border-top: 1px solid #555;
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 375px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #d0d0d0;
            text-decoration: none;
        }

        .nav-item.active {
            color: #f0e6d4;
        }

        .nav-item.active i {
            color: #f0e6d4;
        }

        .nav-item i {
            font-size: 1.5em;
            margin-bottom: 5px;
            color: #d0d0d0;
        }

        .nav-item span {
            font-size: 0.8em;
        }

         /* Add Budget Button */
        .add-button {
            background-color: #b8860b;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: fixed;
            bottom: 90px;
            right: 20px;
            text-decoration: none;
        }

        /* Budget Options Section Styles */
        .budget-options-page {
            display: none;
            padding: 20px;
            margin: 0 20px 20px 20px;
            background-color: #3a3a3a;
            border-radius: 15px;
            text-align: center;
        }

        .budget-options-page h2 {
            margin-top: 0;
            margin-bottom: 20px;
        }

        .budget-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            justify-content: center;
        }

        .budget-option-item {
            background-color: #444;
            border-radius: 10px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .budget-option-item i {
            font-size: 2em;
            margin-bottom: 10px;
            display: block;
        }

        .budget-option-item span {
            font-weight: bold;
            display: block;
        }

        .budget-option-item:hover, .budget-option-item.active {
            background-color: #555;
        }

         /* Transaction list container and items (reused for budget list) */
        .budget-list-container {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 60px;
        }

        .transaction-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .transaction-item {
            background-color: #3a3a3a;
            border-radius: 15px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Align items to the top */
            flex-direction: column; /* Stack details and progress info vertically */
            cursor: pointer; /* Indicate item is clickable */
        }

        .transaction-details {
            text-align: left;
            flex-grow: 1;
            margin-right: 10px;
            margin-bottom: 10px; /* Add margin below details */
        }

        .transaction-details p {
            margin: 0 0 5px 0;
            font-weight: bold;
            font-size: 1em;
        }

        .transaction-details span {
            font-size: 0.9em;
            color: #d0d0d0;
        }

        .transaction-amount {
            text-align: right;
            font-size: 1em;
            font-weight: bold;
            white-space: nowrap;
        }

        /* New "Transactions to Include" Styles */
        .transactions-to-include-section {
            background-color: #3a3a3a;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .transactions-to-include-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            text-align: left;
             display: flex; /* Enable flexbox for icon and text */
            align-items: center; /* Vertically align icon and text */
            gap: 8px; /* Space between icon and text */
        }

        .filter-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-option {
            background-color: #444;
            border-radius: 10px;
            padding: 10px 15px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.9em;
        }

        .filter-option.active {
            background-color: #555;
        }

        .filter-categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
        }

        .filter-category {
            background-color: #444;
            border-radius: 10px;
            padding: 8px 12px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.85em;
            display: flex; /* Enable flex layout for icon and text */
            flex-direction: column; /* Stack icon and text vertically */
            align-items: center; /* Center items horizontally */
            justify-content: center; /* Center items vertically */
        }

        .filter-category i {
            font-size: 1.5em; /* Icon size */
            margin-bottom: 5px; /* Space between icon and text */
        }


        .filter-category.active {
            background-color: #555;
        }

        .filter-accounts-grid, .filter-exclude-categories-grid { /* Reusing grid styles */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 15px; /* Spacing below account/exclude grids */
        }

        .filter-account, .filter-exclude-category {
            background-color: #444;
            border-radius: 10px;
            padding: 8px 12px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.85em;
        }

        .filter-account.active, .filter-exclude-category.active {
            background-color: #555;
        }

        /* Updated style for "Create Budget" Button */
        .set-name-button {
            background-color: #b8860b; /* Orange background, same as "+" button */
            color: #fff; /* White text */
            border: none;
            border-radius: 15px;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin-top: 20px; /* Add some top margin if needed */
            width: calc(100% - 40px); /* Full width minus padding from container */
        }

         .budget-remaining {
            font-size: 1em;
            color: #00a86b; /* Green color for remaining amount */
            text-align: right;
            font-weight: bold;
            white-space: nowrap;
        }

        /* Loading Animation Styles */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* High z-index to be on top */
            display: none; /* Hidden by default */
        }

        .spinner {
            border: 7px solid rgba(255, 255, 255, 0.3);
            border-top: 7px solid #f0e6d4;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


    </style>
</head>
<body>

    <div id="loading-overlay"> <div class="spinner"></div>
    </div>

    <div class="app-container">
        <header data-sr-reveal="enter top">
            <a href="index.html">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <h1>Budgets</h1>
        </header>
        <section class="budget-page-content" data-sr-reveal="enter bottom">

            <div id="budget-options-page" class="budget-options-page">
                <h2>Choose Budget Type</h2>
                <div class="budget-options-grid">
                    <div class="budget-option-item" data-budget-type="expense">
                        <i class="fa-solid fa-arrow-down" style="color: #e24040;"></i>
                        <span>Expense Budget</span>
                    </div>
                    <div class="budget-option-item" data-budget-type="savings">
                        <i class="fa-solid fa-arrow-up" style="color: #00a86b;"></i>
                        <span>Savings Budget</span>
                    </div>
                    </div>
            </div>

            <div id="add-budget-form-container" class="add-budget-section">
                <h2 class="add-budget-header">Create <span id="budget-form-type-title">Budget</span></h2>
                <div class="budget-type-options" style="display:none;">  <div class="budget-option active">Expense budget</div>
                    <div class="budget-option">Savings budget</div>
                </div>


                <div class="input-group">
                    <label for="budget-name">Name</label>
                    <input type="text" id="budget-name" placeholder="Budget Name">
                </div>
                <div class="period-info">
                    <div class="period-input-group">
                        <label for="budget-amount">$</label>
                        <input type="number" id="budget-amount" placeholder="0">
                        <label for="budget-month">/month</label>
                        <select id="budget-month">
                            <option value="">Select Month</option>
                            <option value="january">January</option>
                            <option value="february">February</option>
                            <option value="march">March</option>
                            <option value="april">April</option>
                            <option value="may">May</option>
                            <option value="june">June</option>
                            <option value="july">July</option>
                            <option value="august">August</option>
                            <option value="september">September</option>
                            <option value="october">October</option>
                            <option value="november">November</option>
                            <option value="december">December</option>
                        </select>
                        <label for="budget-start-date">starting</label>
                        <input type="date" id="budget-start-date">
                    </div>
                    <div class="period-details"></div>
                </div>
                <button id="set-name-button" class="set-name-button">Create Budget</button>

                <div class="transactions-to-include-section">
                    <h3><i class="fa-solid fa-filter"></i> Transactions to Include</h3>

                    <h4>Transaction Type</h4>
                    <div class="filter-options-grid">
                        <div class="filter-option active" data-filter="transaction-type" data-value="default">Default</div>
                        <div class="filter-option" data-filter="transaction-type" data-value="income">Income</div>
                        <div class="filter-option" data-filter="transaction-type" data-value="lent-borrowed">Lent & Borrowed</div>
                    </div>

                    <h4><i class="fa-solid fa-university"></i> Select Accounts</h4>
                    <div class="filter-accounts-grid">
                        <div class="filter-account active" data-filter="account" data-value="all">All Accounts</div>
                        <div class="filter-account" data-filter="account" data-value="bank">Bank</div>
                        </div>

                    <h4><i class="fa-solid fa-tags"></i> Select Categories</h4>
                    <div class="filter-categories-grid" id="budget-categories-filter">
                        <div class="filter-category active" data-filter="category" data-value="all">All</div>
                        <div class="filter-category" data-filter="category" data-value="dining"><i class="fa-solid fa-utensils"></i>Dining</div>
                        <div class="filter-category" data-filter="category" data-value="shopping"><i class="fa-solid fa-shopping-cart"></i>Shopping</div>
                        <div class="filter-category" data-filter="category" data-value="transit"><i class="fa-solid fa-bus"></i>Transit</div>
                        <div class="filter-category" data-filter="category" data-value="entertainment"><i class="fa-solid fa-film"></i>Entertainment</div>
                        <div class="filter-category" data-filter="category" data-value="bills & fees"><i class="fa-solid fa-file-invoice-dollar"></i>Bills & Fees</div>
                        <div class="filter-category" data-filter="category" data-value="gifts"><i class="fa-solid fa-gift"></i>Gifts</div>
                        <div class="filter-category" data-filter="category" data-value="beauty"><i class="fa-solid fa-heart"></i>Beauty</div>
                        <div class="filter-category" data-filter="category" data-value="work"><i class="fa-solid fa-briefcase"></i>Work</div>
                        <div class="filter-category" data-filter="category" data-value="travel"><i class="fa-solid fa-plane"></i>Travel</div>
                        <div class="filter-category" data-filter="category" data-value="income"><i class="fa-solid fa-money-bill-wave"></i>Income</div>
                         </div>

                    <h4><i class="fa-solid fa-tag"></i> Exclude Categories</h4>
                    <div class="filter-exclude-categories-grid"  id="budget-exclude-categories-filter">
                         <div class="filter-exclude-category" data-filter="exclude-category" data-value="dining">Dining</div>
                        <div class="filter-exclude-category" data-filter="exclude-category" data-value="groceries">Groceries</div>
                        <div class="filter-exclude-category" data-filter="exclude-category" data-value="shopping">Shopping</div>
                        <div class="filter-exclude-category" data-filter="exclude-category" data-value="transit">Transit</div>
                        </div>
                </div>
            </div>

             <div id="budget-list-container" class="budget-page-content">
                <div class="budget-list-container">
                    <div class="transaction-list">
                        <p>No budgets yet</p>
                    </div>
                </div>
            </div>
        </section>
        <nav class="bottom-nav" data-sr-reveal="enter bottom">
            <a href="index.html" class="nav-item">
                <i class="fa-solid fa-house"></i>
                <span>Home</span>
            </a>
            <a href="transaction.html" class="nav-item">
                <i class="fa-solid fa-receipt"></i>
                <span>Transactions</span>
            </a>
            <a href="budget.html" class="nav-item active">
                <i class="fa-solid fa-list-check"></i>
                <span>Budgets</span>
            </a>
            <a href="more.html" class="nav-item">
                <i class="fa-solid fa-ellipsis-h"></i>
                <span>More</span>
            </a>
        </nav>
         <a href="#" class="add-button" id="addBudgetBtn" data-sr-reveal="enter bottom">+</a>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addBudgetBtn = document.getElementById('addBudgetBtn');
            const formContainer = document.getElementById('add-budget-form-container');
            const budgetOptionsPage = document.getElementById('budget-options-page');
            const monthSelect = document.getElementById('budget-month');
            const startDateInput = document.getElementById('budget-start-date');
            const periodDisplay = document.querySelector('.period-details');
            const createBtn = document.getElementById('set-name-button');
            const budgetTypeOptions = document.querySelectorAll('.budget-option');
            const budgetListContainer = document.getElementById('budget-list-container');
            const budgetFormTypeTitle = document.getElementById('budget-form-type-title');
            const budgetOptionItems = document.querySelectorAll('.budget-option-item');
            const addBudgetHeader = document.querySelector('.add-budget-header');
            const setNameButton = document.getElementById('set-name-button');
            const loadingOverlay = document.getElementById('loading-overlay'); // Get loading overlay


            let selectedMonth = null;
            let end_date = null;
            let budgets = [];
            let currentBudgetType = 'expense budget';
            let editBudgetIndex = null; // Track index of budget being edited


             // Category icon mapping (from transaction.html)
            const categoryIcons = {
                'Dining': 'fa-solid fa-utensils',
                'Shopping': 'fa-solid fa-shopping-cart',
                'Transit': 'fa-solid fa-bus',
                'Entertainment': 'fa-solid fa-film',
                'Bills & Fees': 'fa-solid fa-file-invoice-dollar',
                'Gifts': 'fa-solid fa-gift',
                'Beauty': 'fa-solid fa-heart',
                'Work': 'fa-solid fa-briefcase',
                'Travel': 'fa-solid fa-plane',
                'Income': 'fa-solid fa-money-bill-wave'
            };


            // Function to load budgets from local storage
            function loadBudgets() {
                loadingOverlay.style.display = 'flex'; // Show loading overlay
                const storedBudgets = localStorage.getItem('budgets');
                if (storedBudgets) {
                    budgets = JSON.parse(storedBudgets);
                }
                displayBudgets(); // Call displayBudgets after loading
                loadingOverlay.style.display = 'none'; // Hide loading overlay after budgets are displayed
            }

            // Function to save budgets to local storage
            function saveBudgets() {
                localStorage.setItem('budgets', JSON.stringify(budgets));
            }

            // Function to load transactions from local storage
            function loadTransactions() {
                const storedTransactions = localStorage.getItem('transactions');
                return storedTransactions ? JSON.parse(storedTransactions) : [];
            }


            function displayBudgets() {
                const budgetListDiv = budgetListContainer.querySelector('.transaction-list');
                budgetListDiv.innerHTML = '';
                const noBudgetMessage = document.createElement('p');
                noBudgetMessage.textContent = 'No budgets yet';

                if (budgets.length === 0) {
                    budgetListDiv.appendChild(noBudgetMessage);
                    noBudgetMessage.style.display = 'block';
                } else {
                    noBudgetMessage.style.display = 'none';
                    budgets.forEach((budget, index) => {
                        const budgetItem = document.createElement('div');
                        budgetItem.classList.add('transaction-item');
                        budgetItem.addEventListener('click', function() {
                            openEditBudgetOverlay(index); // Open overlay for edit
                        });


                        // Transaction Details Div (Name and Type/Period)
                        const detailsDiv = document.createElement('div');
                        detailsDiv.classList.add('transaction-details');
                        detailsDiv.innerHTML = `
                            <p>${budget.name}</p>
                            <span>${budget.type} - ${formatDate(new Date(budget.startDate))} to ${formatDate(new Date(budget.endDate))}</span>
                        `;
                        budgetItem.appendChild(detailsDiv);

                        // Calculate total expenses for this budget
                        const transactions = loadTransactions();
                        let totalExpenses = 0;
                        const budgetStartDate = new Date(budget.startDate); // Budget start date
                        const budgetEndDate = new Date(budget.endDate);     // Budget end date


                        // Filter transactions to include only 'expense' type AND 'expense' transaction type AND within the budget month/year
                        const filteredTransactions = transactions.filter(transaction => {
                            if (budget.type === 'expense budget' && transaction.type === 'expense') {
                                const transactionDate = new Date(transaction.date);
                                // Check if transaction is within the budget's month and year
                                return transactionDate >= budgetStartDate && transactionDate <= budgetEndDate &&
                                       transactionDate.getMonth() === budgetStartDate.getMonth() && transactionDate.getFullYear() === budgetStartDate.getFullYear();
                            }
                            return false; // Exclude if not expense budget or not expense type
                        });


                        filteredTransactions.forEach(transaction => {
                            if (transaction.type === 'expense') {
                                totalExpenses += parseFloat(transaction.amount);
                            }
                        });

                        const remainingAmount = budget.amount - totalExpenses;


                        // Budget Progress Info Container (Progress bar, percentage, suggestion)
                        const progressInfoDiv = document.createElement('div');
                        progressInfoDiv.classList.add('budget-list-progress-info');

                        // Progress Bar
                        const progressDiv = document.createElement('div');
                        progressDiv.classList.add('budget-progress');
                        const progressBar = document.createElement('div');
                        progressBar.classList.add('budget-progress-bar');
                        progressBar.style.width = `0%`; // Initial width 0

                        const percentageSpan = document.createElement('span');
                        percentageSpan.classList.add('budget-percentage');
                        percentageSpan.textContent = `0%`; // Initial percentage text


                        progressDiv.appendChild(progressBar);
                        progressDiv.appendChild(percentageSpan);
                        progressInfoDiv.appendChild(progressDiv);


                        // Suggestion Text
                        const suggestionP = document.createElement('p');
                        suggestionP.classList.add('budget-suggestion');
                        suggestionP.textContent = budget.daysLeft > 0 ? `Suggest: $${budget.dailyAmount}/day for ${budget.daysLeft} days` : 'Budget period ended';
                        progressInfoDiv.appendChild(suggestionP);

                        budgetItem.appendChild(progressInfoDiv); // Append progress info to budget item

                         // Remaining Amount Display
                        const remainingAmountDiv = document.createElement('div');
                        remainingAmountDiv.classList.add('budget-remaining');
                        remainingAmountDiv.textContent = `Left: $${remainingAmount.toFixed(2)}`; // Display remaining amount
                        budgetItem.appendChild(remainingAmountDiv);

                        // Delete Button
                        const deleteButton = document.createElement('button');
                        deleteButton.classList.add('delete-button');
                        deleteButton.innerHTML = '<i class="fa-solid fa-trash"></i>';
                        deleteButton.addEventListener('click', function(event) {
                            event.stopPropagation(); // Stop item click event
                            deleteBudget(index); // Call deleteBudget with the index
                        });
                        budgetItem.appendChild(deleteButton);


                        // Amount (moved to be visually separate if needed, can adjust placement)
                        const amountDiv = document.createElement('div');
                        amountDiv.classList.add('transaction-amount');
                        amountDiv.textContent = '$' + budget.amount;
                        budgetItem.appendChild(amountDiv);


                        budgetListDiv.appendChild(budgetItem);

                        // Animate progress bar after a short delay
                        setTimeout(() => {
                            let progressPercentage = 0;
                            if (budget.amount > 0) {
                                progressPercentage = ((totalExpenses / budget.amount) * 100).toFixed(0);
                                if (progressPercentage > 100) progressPercentage = 100;
                            }

                            let currentWidth = 0;
                            const intervalTime = 10; // Interval in milliseconds, adjust for speed
                            const incrementStep = progressPercentage / (500 / intervalTime); // Increment per interval

                            const interval = setInterval(() => {
                                currentWidth += incrementStep;
                                if (currentWidth >= progressPercentage) {
                                    clearInterval(interval);
                                    currentWidth = progressPercentage;
                                }
                                progressBar.style.width = `${currentWidth}%`;
                                percentageSpan.textContent = `${Math.floor(currentWidth)}%`; // Update percentage text
                            }, intervalTime);
                        }, 100); // Short delay before animation starts
                    });
                }
            }

            function deleteBudget(index) {
                budgets.splice(index, 1); // Remove budget from array
                saveBudgets(); // Save updated budgets to local storage
                displayBudgets(); // Re-render the list
            }

            function openEditBudgetOverlay(index) {
                editBudgetIndex = index; // Set the index of budget being edited
                addBudgetHeader.textContent = 'Edit Budget'; // Change overlay header
                setNameButton.textContent = 'Update Budget'; // Change button text

                const budget = budgets[index];

                // Populate form fields with budget details
                document.getElementById('budget-name').value = budget.name;
                document.getElementById('budget-amount').value = budget.amount;
                document.getElementById('budget-month').value = budget.month;
                document.getElementById('budget-start-date').value = budget.startDate;

                // Set budget type - assuming budget.type is like "expense budget" or "savings budget"
                const budgetTypeToSelect = budget.type.toLowerCase(); // e.g., "expense budget"
                budgetOptionItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.budgetType + ' budget' === budgetTypeToSelect) {
                        item.classList.add('active');
                        currentBudgetType = budgetTypeToSelect;
                        budgetFormTypeTitle.textContent = currentBudgetType.charAt(0).toUpperCase() + currentBudgetType.slice(1);
                    }
                });


                formContainer.style.display = 'block'; // Show budget form
                budgetOptionsPage.style.display = 'none'; // Hide options page if it was visible
                budgetListContainer.style.display = 'none'; // Hide budget list

            }


            function resetBudgetForm() {
                document.getElementById('budget-name').value = '';
                document.getElementById('budget-amount').value = '';
                document.getElementById('budget-month').value = '';
                document.getElementById('budget-start-date').value = '';
                addBudgetHeader.textContent = 'Create <span id="budget-form-type-title">Budget</span>'; // Reset overlay header
                setNameButton.textContent = 'Create Budget'; // Reset button text
                editBudgetIndex = null; // Clear edit index

                budgetOptionItems.forEach(item => item.classList.remove('active')); // Clear budget type selection
                budgetOptionItems[0].classList.add('active'); // Default to expense budget
                currentBudgetType = 'expense budget';
                budgetFormTypeTitle.textContent = currentBudgetType.charAt(0).toUpperCase() + currentBudgetType.slice(1);


                updatePeriodDisplay();
            }


            // Load budgets on page load
            loadBudgets();


            function updatePeriodDisplay() {
                let selectedMonthValue = monthSelect.value;
                if (!selectedMonthValue) {
                    const currentDate = new Date();
                    selectedMonthValue = currentDate.toLocaleString('default', { month: 'long' }).toLowerCase();
                }
                selectedMonth = selectedMonthValue;

                const year = new Date().getFullYear();
                const monthIndex = monthNameToIndex(selectedMonthValue);
                const startDate = startDateInput.value ? new Date(startDateInput.value) : new Date(year, monthIndex, 1);
                end_date = new Date(year, monthIndex + 1, 0);

                periodDisplay.innerHTML = `Budget Period<br>${formatDate(startDate)} - ${formatDate(end_date)}`;
            }

            function monthNameToIndex(name) {
                const months = ["january", "february", "march", "april", "may", "june",
                              "july", "august", "september", "october", "november", "december"];
                return months.indexOf(name.toLowerCase());
            }

            function formatDate(date) {
                return date.toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });
            }

             function saveBudget() { // Renamed from calculateBudget to saveBudget
                const name = document.getElementById('budget-name').value;
                const amount = parseFloat(document.getElementById('budget-amount').value);
                // --- CORRECTED SELECTOR for budget type ---
                const typeElement = document.querySelector('#budget-options-page .budget-option-item.active');


                const currentMonthValue = monthSelect.value;
                const startDateValue = startDateInput.value;


                if (!name || isNaN(amount) || !typeElement || !currentMonthValue || !startDateValue) {
                    let message = 'Please fill all required fields:\n';
                    if (!name) message += '- Budget Name\n';
                    if (isNaN(amount)) message += '- Budget Amount (must be a number)\n';
                    if (!typeElement) message += '- Budget Type\n'; // Should not happen in current UI
                    if (!currentMonthValue) message += '- Month\n';
                    if (!startDateValue) message += '- Start Date\n';
                    alert(message);
                    return;
                }

                const type = currentBudgetType;
                const year = new Date().getFullYear();
                const monthIndex = monthNameToIndex(currentMonthValue);
                const startDate = new Date(startDateValue);
                const endDate = new Date(year, monthIndex + 1, 0);
                const today = new Date();


                if (startDate.getMonth() !== monthIndex || startDate.getFullYear() !== year) {
                    alert('Start date must be within the selected month and year');
                    return;
                }

                const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                let daysElapsed, daysLeft, progress, dailyAmount;

                if (today < startDate) {
                    daysElapsed = 0;
                    daysLeft = totalDays;
                    progress = 0;
                    dailyAmount = (amount / totalDays).toFixed(0);
                } else if (today > endDate) {
                    daysElapsed = totalDays;
                    daysLeft = 0;
                    progress = 100;
                    dailyAmount = 0;
                } else {
                    daysElapsed = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
                    daysLeft = totalDays - daysElapsed;
                    progress = ((daysElapsed / totalDays) * 100).toFixed(0);
                    dailyAmount = (amount / (daysLeft || 1)).toFixed(0);
                }

                const updatedBudget = { // Use updatedBudget for both new and edited budgets
                    name: name,
                    amount: amount,
                    type: type,
                    startDate: startDate,
                    endDate: endDate,
                    daysLeft: daysLeft,
                    dailyAmount: dailyAmount,
                    progress: progress,
                    month: currentMonthValue // Added month to budget object
                };


                if (editBudgetIndex !== null) {
                    // Edit existing budget
                    budgets[editBudgetIndex] = updatedBudget;
                    editBudgetIndex = null; // Clear edit index after update
                } else {
                    // Add new budget
                    budgets.push(updatedBudget);
                }


                saveBudgets(); // Save budgets to local storage
                displayBudgets();

                formContainer.style.display = 'none';
                budgetOptionsPage.style.display = 'none';
                budgetListContainer.style.display = 'block';

                resetBudgetForm(); // Call resetBudgetForm to clear and reset form fields
            }


            // Event Listeners
            addBudgetBtn.addEventListener('click', () => {
                resetBudgetForm(); // Reset form when add budget is clicked
                budgetOptionsPage.style.display = 'block';
                formContainer.style.display = 'none';
                budgetListContainer.style.display = 'none';
                currentBudgetType = 'expense budget';
                budgetFormTypeTitle.textContent = currentBudgetType.charAt(0).toUpperCase() + currentBudgetType.slice(1);
                addBudgetHeader.textContent = 'Create Budget'; // Ensure header is "Create Budget"
                setNameButton.textContent = 'Create Budget'; // Ensure button text is "Create Budget"

            });

            budgetOptionItems.forEach(optionItem => {
                optionItem.addEventListener('click', function() {
                    // Remove active class from other items
                    budgetOptionItems.forEach(item => item.classList.remove('active'));
                    // Add active class to the clicked item
                    this.classList.add('active');

                    const budgetType = this.dataset.budgetType;
                    currentBudgetType = budgetType + ' budget';
                    budgetFormTypeTitle.textContent = currentBudgetType.charAt(0).toUpperCase() + currentBudgetType.slice(1);
                    budgetOptionsPage.style.display = 'none';
                    formContainer.style.display = 'block';
                    budgetListContainer.style.display = 'none';
                });
            });


            monthSelect.addEventListener('change', () => {
                selectedMonth = monthSelect.value;
                updatePeriodDisplay();
            });

            startDateInput.addEventListener('change', updatePeriodDisplay);


            createBtn.addEventListener('click', saveBudget); // Renamed function here as well


            // --- New Event Listeners for Filter Options ---
            const filterOptions = document.querySelectorAll('.filter-option, .filter-account, .filter-category, .filter-exclude-category');
            const categoryFilterGrid = document.getElementById('budget-categories-filter');
            const excludeCategoryFilterGrid = document.getElementById('budget-exclude-categories-filter');


            // Function to create category filter buttons
            function createCategoryFilters(categories, filterType, parentElement) {
                parentElement.innerHTML = ''; // Clear existing filters
                if (filterType === 'category') {
                    const allCategoriesOption = document.createElement('div');
                    allCategoriesOption.classList.add('filter-category', 'active');
                    allCategoriesOption.dataset.filter = filterType;
                    allCategoriesOption.dataset.value = 'all';
                    allCategoriesOption.textContent = 'All';
                    parentElement.appendChild(allCategoriesOption);
                }


                categories.forEach(categoryName => {
                    const filterCategory = document.createElement('div');
                    filterCategory.classList.add('filter-category');
                    filterCategory.dataset.filter = filterType;
                    filterCategory.dataset.value = categoryName.toLowerCase(); // Use lowercase for data-value
                    filterCategory.innerHTML = `<i class="${categoryIcons[categoryName]}"></i>${categoryName}`; // Include icon and category name
                    parentElement.appendChild(filterCategory);
                });
            }


            // --- Category data from transaction.html ---
            const transactionCategories = [
                'Dining', 'Shopping', 'Transit', 'Entertainment', 'Bills & Fees', 'Gifts', 'Beauty', 'Work', 'Travel', 'Income'
            ];


            createCategoryFilters(transactionCategories, 'category', categoryFilterGrid);
            createCategoryFilters(transactionCategories, 'exclude-category', excludeCategoryFilterGrid);


            // Reattach event listeners after recreating filters
            const updatedFilterOptions = document.querySelectorAll('.filter-option, .filter-account, .filter-category, .filter-exclude-category');
            updatedFilterOptions.forEach(option => {
                option.addEventListener('click', function() {
                    this.classList.toggle('active');
                });
            });

             // ScrollReveal Configuration
            ScrollReveal({ reset: true });

            ScrollReveal().reveal('header', { delay: 200, origin: 'top', distance: '50px' });
            ScrollReveal().reveal('.budget-page-content', { delay: 300, origin: 'bottom', distance: '50px' });
            ScrollReveal().reveal('.bottom-nav', { delay: 400, origin: 'bottom', distance: '50px' });
            ScrollReveal().reveal('.add-button', { delay: 500, origin: 'bottom', distance: '50px' });
        });
    </script>
</body>
</html>
